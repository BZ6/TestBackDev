# TestBackDev

## Задание

Написать часть сервиса аутентификации.

Два REST маршрута:

- Первый маршрут выдает пару Access, Refresh токенов для пользователя с идентификатором (GUID) указанным в параметре запроса
- Второй маршрут выполняет Refresh операцию на пару Access, Refresh токенов

**Требования:**

Access токен тип JWT, алгоритм SHA512, хранить в базе строго запрещено.

Refresh токен тип произвольный, формат передачи base64, хранится в базе исключительно в виде bcrypt хеша, должен быть защищен от изменения на стороне клиента и попыток повторного использования.

Access, Refresh токены обоюдно связаны, Refresh операцию для Access токена можно выполнить только тем Refresh токеном который был выдан вместе с ним.

Payload токенов должен содержать сведения об ip адресе клиента, которому он был выдан. В случае, если ip адрес изменился, при рефреш операции нужно послать email warning на почту юзера (для упрощения можно использовать моковые данные).

## Описание

Этот проект представляет собой часть сервиса аутентификации, реализованного на языке Go.
Он включает несколько REST маршрутов:

1. **Выдача токенов**: маршрут `/auth/token` генерирует пару Access и Refresh токенов для
пользователя с указанным идентификатором. Access токен имеет тип JWT с алгоритмом SHA512,
а Refresh токен хранится в базе данных в виде bcrypt хеша и передается в формате base64.

2. **Обновление токенов**: маршрут `/auth/token` выполняет операцию обновления (refresh)
для пары Access и Refresh токенов. Refresh токен должен быть выдан вместе с соответствующим
Access токеном. Токены защищены от повторного использования с помощью флага used, хранящегося
в базе данных для каждого Refresh токена. Токены обоюдно связаны с помощью UUID Access токена.
В маршрут refresh передаются Access и Refresh токены в теле запроса. Если
захочется протестировать к примеру с помощью postman, то это надо будет учесть.

3. **Проверка**: маршрут `/healthz` используется для проверки состояния приложения. Если приложение успешно запущено, он возвращает статус `200 OK`. Такой маршрут нужен, чтобы при запуске докера тесты дождались разворачивания приложения.

В проекте есть много лишних моментов, такие как модель User или хранение UserID и IP
сразу в Access и Refresh токенах, но это может понадобится, если придется все-таки
реализовывать отправку писем или еще какую-то логику.

## Инструкция использования

Для начала надо будет создать и заполнить `.env` файл в корне рабочей дириктории

```bash
touch .env
```

Затем заполнить чем-то таким:

- JWT_SECRET=secret-key
- TOKEN_EXPIRY=15
- DATABASE_DSN=host=postgres user=db_user password=db_password dbname=db_name port=5432 sslmode=disable
- POSTGRES_USER=db_user
- POSTGRES_PASSWORD=db_password
- POSTGRES_DB=db_name

Если хочется запустить приложение, то это можно сделать с помощью докера

```bash
docker-compose up --build
```

Если хочется запустить тесты отдельно, то это можно сделать с помощью докера,
но только при запущенном приложении!

```bash
docker-compose up test
```
